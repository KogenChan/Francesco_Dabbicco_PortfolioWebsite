import{useState,useEffect}from"react";import useFetchData from"./useFetchData";import{useGlobalLoading}from"../context/LoadingContext";const loadPhotosWithDimensions=async e=>Promise.all(e.map((e=>new Promise((t=>{const o=new Image;o.onload=()=>{t({src:e.image,width:o.naturalWidth,height:o.naturalHeight,key:e.id})},o.onerror=()=>{t({src:e.image,width:800,height:600,key:e.id})},o.src=e.image}))))),isInViewport=e=>{const t=e.getBoundingClientRect();return t.top<window.innerHeight&&t.bottom>0&&t.left<window.innerWidth&&t.right>0};export default function usePhotos(e,t={}){const{waitForRender:o=!0,imageSelector:r=".react-photo-album--image"}=t,{startLoading:n,stopLoading:i}=useGlobalLoading(),{data:a,loading:s,error:l}=useFetchData(e,{manageLoading:!1}),[u,c]=useState([]),[d,m]=useState(!1),[g,h]=useState(!1),[f,p]=useState(null);return useEffect((()=>{n()}),[n]),useEffect((()=>{if(l)return p(l),void i();if(!a||0===a.length||s)return;let e=!0;return m(!0),h(!1),p(null),loadPhotosWithDimensions(a).then((t=>{e&&c(t)})).catch((()=>{e&&p("Failed loading images")})).finally((()=>{e&&m(!1),o||i()})),()=>{e=!1}}),[a,l,s,o,i]),useEffect((()=>{if(!o)return;if(d||s||0===u.length)return;if(g)return;let e=0;const t=()=>{const o=document.querySelectorAll(r);if(0===o.length)return e++,void(e<10?setTimeout(t,50):(h(!0),i()));const n=Array.from(o).filter(isInViewport);if(0===n.length)return h(!0),void i();n.every((e=>e.complete))?(h(!0),i()):Promise.all(n.map((e=>e.complete?Promise.resolve():new Promise((t=>{e.onload=t,e.onerror=t}))))).then((()=>{h(!0),i()}))};t()}),[d,s,u,g,r,o,i]),{photos:u,loading:s||d||o&&!g,error:f}}