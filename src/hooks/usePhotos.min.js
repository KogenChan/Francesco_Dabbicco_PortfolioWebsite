import{useState,useEffect}from"react";import useFetchData from"./useFetchData";import{useGlobalLoading}from"../context/LoadingContext";const loadPhotosWithDimensions=async e=>Promise.all(e.map((e=>new Promise((t=>{const o=new Image;o.onload=()=>{t({src:e.image,width:o.naturalWidth,height:o.naturalHeight,key:e.id})},o.onerror=()=>{t({src:e.image,width:800,height:600,key:e.id})},o.src=e.image})))));export default function usePhotos(e,t={}){const{waitForRender:o=!0,imageSelector:r=".react-photo-album--image"}=t,{startLoading:a,stopLoading:n}=useGlobalLoading(),{data:i,loading:s,error:l}=useFetchData(e,{manageLoading:!1}),[u,m]=useState([]),[c,d]=useState(!1),[h,g]=useState(!1),[f,p]=useState(null);return useEffect((()=>{a()}),[a]),useEffect((()=>{if(l)return p(l),void n();if(!i||0===i.length||s)return;let e=!0;return d(!0),g(!1),p(null),loadPhotosWithDimensions(i).then((t=>{e&&m(t)})).catch((()=>{e&&p("Failed loading images")})).finally((()=>{e&&d(!1),o||n()})),()=>{e=!1}}),[i,l,s,o,n]),useEffect((()=>{if(!o)return;if(c||s||0===u.length)return;if(h)return;const e=()=>{const t=document.querySelectorAll(r);if(0===t.length)return void setTimeout(e,50);const o=Array.from(t);o.every((e=>e.complete))?(g(!0),n()):Promise.all(o.map((e=>e.complete?Promise.resolve():new Promise((t=>{e.onload=t,e.onerror=t}))))).then((()=>{g(!0),n()}))};e()}),[c,s,u,h,r,o,n]),{photos:u,loading:s||c||o&&!h,error:f}}